{% extends 'base.html' %}

{% block title %}Upload Video - {{ case.name }} - Detectify{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <div>
        <h1 class="h2">Upload Video</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'cases:dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'cases:case_detail' case.id %}">{{ case.name }}</a></li>
                <li class="breadcrumb-item active">Upload Video</li>
            </ol>
        </nav>
    </div>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{% url 'cases:case_detail' case.id %}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to Case
            </a>
        </div>
    </div>
</div>

<!-- Upload Form -->
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-video me-2"></i>Upload Video for Analysis</h5>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="videoUploadForm">
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <label for="{{ form.video_file.id_for_label }}" class="form-label">
                            <i class="fas fa-file-video me-2"></i>Select Video File
                        </label>
                        {{ form.video_file }}
                        {% if form.video_file.help_text %}
                        <div class="form-text">{{ form.video_file.help_text }}</div>
                        {% endif %}
                        {% if form.video_file.errors %}
                        <div class="text-danger small mt-1">{{ form.video_file.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- File Info Display -->
                    <div id="fileInfo" class="alert alert-info d-none">
                        <h6><i class="fas fa-info-circle me-2"></i>File Information</h6>
                        <div id="fileName"></div>
                        <div id="fileSize"></div>
                        <div class="mt-2">
                            <div class="progress" style="height: 12px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="uploadProgress"></div>
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="text-muted" id="progressText">Ready to upload</small>
                                <small class="text-muted" id="progressPercent">0%</small>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Status -->
                    <div id="uploadStatus" class="alert d-none">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status" id="statusSpinner"></div>
                            <span id="statusText">Preparing upload...</span>
                        </div>
                    </div>

                    <!-- Upload Instructions -->
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Upload Guidelines</h6>
                        <ul class="mb-0">
                            <li>Supported formats: MP4, AVI, MKV, MOV</li>
                            <li>Maximum file size: 500MB</li>
                            <li>Clear video quality improves face detection accuracy</li>
                            <li>Processing time depends on video length and complexity</li>
                        </ul>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'cases:case_detail' case.id %}" class="btn btn-secondary">
                            <i class="fas fa-times me-1"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-info" id="uploadBtn">
                            <i class="fas fa-upload me-1"></i>Upload Video
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Processing Information -->
<div class="row justify-content-center mt-4">
    <div class="col-md-8 col-lg-6">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h6><i class="fas fa-cogs me-2"></i>What Happens Next?</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-1 me-2 text-info"></i>Metadata Extraction</h6>
                        <p class="small text-muted">Video duration, resolution, and format information will be extracted automatically.</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-2 me-2 text-info"></i>Face Detection</h6>
                        <p class="small text-muted">The system will scan the video for faces and prepare it for suspect matching.</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-3 me-2 text-info"></i>Suspect Matching</h6>
                        <p class="small text-muted">Detected faces will be compared against your uploaded suspect images.</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-4 me-2 text-info"></i>Results Generation</h6>
                        <p class="small text-muted">A processed video with detection highlights will be generated for download.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('{{ form.video_file.id_for_label }}');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const uploadForm = document.getElementById('videoUploadForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadStatus = document.getElementById('uploadStatus');
    const progressBar = document.getElementById('uploadProgress');
    const progressText = document.getElementById('progressText');
    const progressPercent = document.getElementById('progressPercent');

    let isUploading = false;

    // File selection handler
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        
        if (file) {
            // Show file information
            fileName.innerHTML = '<strong>File:</strong> ' + file.name;
            fileSize.innerHTML = '<strong>Size:</strong> ' + formatFileSize(file.size);
            fileInfo.classList.remove('d-none');
            
            // Reset progress
            progressBar.style.width = '0%';
            progressPercent.textContent = '0%';
            progressText.textContent = 'Ready to upload';
            
            // Validate file size (500MB = 500 * 1024 * 1024 bytes)
            const maxSize = 500 * 1024 * 1024;
            if (file.size > maxSize) {
                showError('File size exceeds 500MB limit. Please select a smaller file.');
                fileInput.value = '';
                fileInfo.classList.add('d-none');
                return;
            }
            
            // Validate file type
            const fileExtension = file.name.split('.').pop().toLowerCase();
            const allowedExtensions = ['mp4', 'avi', 'mov', 'mkv'];
            
            if (!allowedExtensions.includes(fileExtension)) {
                showError('Invalid file type. Please select an MP4, AVI, MOV, or MKV file.');
                fileInput.value = '';
                fileInfo.classList.add('d-none');
                return;
            }
            
            uploadBtn.disabled = false;
        } else {
            fileInfo.classList.add('d-none');
            uploadBtn.disabled = true;
        }
    });

    // Form submission handler with AJAX
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (isUploading) return;
        
        const file = fileInput.files[0];
        
        if (!file) {
            showError('Please select a video file to upload.');
            return;
        }
        
        isUploading = true;
        
        // Show upload status
        uploadStatus.classList.remove('d-none');
        uploadStatus.className = 'alert alert-info';
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Uploading...';
        
        // Create FormData for file upload
        const formData = new FormData();
        formData.append('video_file', file);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        // Create XMLHttpRequest for progress tracking
        const xhr = new XMLHttpRequest();
        
        // Track upload progress
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                progressBar.style.width = percentComplete + '%';
                progressPercent.textContent = Math.round(percentComplete) + '%';
                
                if (percentComplete < 100) {
                    progressText.textContent = 'Uploading... ' + formatFileSize(e.loaded) + ' / ' + formatFileSize(e.total);
                    document.getElementById('statusText').textContent = 'Uploading video file...';
                } else {
                    progressText.textContent = 'Upload complete, processing...';
                    document.getElementById('statusText').textContent = 'Processing video metadata...';
                }
            }
        });
        
        // Handle upload completion
        xhr.addEventListener('load', function() {
            if (xhr.status === 200 || xhr.status === 302) {
                // Success - redirect or show success message
                uploadStatus.className = 'alert alert-success';
                document.getElementById('statusText').textContent = 'Upload completed successfully!';
                document.getElementById('statusSpinner').classList.remove('spinner-border');
                document.getElementById('statusSpinner').innerHTML = '<i class="fas fa-check-circle"></i>';
                
                // Redirect after a short delay
                setTimeout(() => {
                    if (xhr.responseURL) {
                        window.location.href = xhr.responseURL;
                    } else {
                        // Fallback redirect
                        window.location.href = "{% url 'cases:case_detail' case.id %}";
                    }
                }, 1500);
            } else {
                handleUploadError('Upload failed. Please try again.');
            }
        });
        
        // Handle upload errors
        xhr.addEventListener('error', function() {
            handleUploadError('Network error occurred during upload.');
        });
        
        xhr.addEventListener('timeout', function() {
            handleUploadError('Upload timeout. Please try again with a smaller file.');
        });
        
        // Set timeout for large files (30 minutes)
        xhr.timeout = 30 * 60 * 1000;
        
        // Send the request
        xhr.open('POST', uploadForm.action || window.location.href);
        xhr.send(formData);
    });

    function handleUploadError(message) {
        isUploading = false;
        uploadStatus.className = 'alert alert-danger';
        document.getElementById('statusText').textContent = message;
        document.getElementById('statusSpinner').classList.remove('spinner-border');
        document.getElementById('statusSpinner').innerHTML = '<i class="fas fa-exclamation-circle"></i>';
        
        // Re-enable form
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-upload me-1"></i>Upload Video';
        
        // Reset progress
        progressBar.style.width = '0%';
        progressPercent.textContent = '0%';
        progressText.textContent = 'Upload failed';
    }

    // Utility functions
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    function showError(message) {
        // Create or update error alert
        let errorAlert = document.querySelector('.alert-danger');
        if (!errorAlert) {
            errorAlert = document.createElement('div');
            errorAlert.className = 'alert alert-danger';
            errorAlert.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>' + message;
            uploadForm.insertBefore(errorAlert, uploadForm.firstChild);
        } else {
            errorAlert.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>' + message;
        }
        
        // Remove error after 5 seconds
        setTimeout(() => {
            if (errorAlert.parentNode) {
                errorAlert.parentNode.removeChild(errorAlert);
            }
        }, 5000);
    }
    
    // Prevent page refresh during upload
    window.addEventListener('beforeunload', function(e) {
        if (isUploading) {
            e.preventDefault();
            e.returnValue = 'Upload in progress. Are you sure you want to leave?';
        }
    });
    
    // Initial state
    uploadBtn.disabled = true;
});

// Processing Status Checker (for after upload)
function checkProcessingStatus(videoId) {
    const statusUrl = "{% url 'cases:video_processing_status' case.id 0 %}".replace('0', videoId);
    
    fetch(statusUrl)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'processing') {
                setTimeout(() => checkProcessingStatus(videoId), 2000);
            } else if (data.status === 'completed') {
                location.reload();
            }
        })
        .catch(() => {
            // Fallback - refresh page after 10 seconds
            setTimeout(() => location.reload(), 10000);
        });
}
</script>
{% endblock %}
